<!DOCTYPE html>
<html>
<head>
  <title>Arogi Traveling Salesman</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link rel="stylesheet" href="leaflet/leaflet.css" />
  <link rel="stylesheet" href="arogi_dark.css" />
  <script src="leaflet/leaflet.js"></script>
  <script src="https://mapzen.com/tangram/0.6/tangram.min.js"></script>
  <!-- // this loads a geojson of starting points.
  // the variable is called defaultMarkers -->
  <script src="data/mclp_data_100.js"></script>

  <style>

  body {
    padding: 0;
    margin: 0;
  }

  #map {
    height: 100%;
    width: 100%;
    padding:0px;
    margin:0px;
    position: absolute;
  }

  </style>
</head>

<body>

  <div id="map"></div>

  <div id="arogi-menu-main">

    <div id="arogi-top-zone">Arogi Circuit</div>
    <div id="arogi-menu-upper">
      <div id="distance-slider-area">Length:</div>
      <div id="download-button"></div>
    </div>

  </div>


  <script>

  //defaultMarkers is called from the data.js script.
  answeredGeoJson = defaultMarkers;


  $(document).ready(function() {

    polyline1 = new Array();
    polyline2 = new Array();
    polyline3 = new Array();
    simpleCount = 0;
    var pointMarkers;


    var useTheseMarkers = JSON.stringify(answeredGeoJson);

    $.ajax({
      type: 'POST',
      url: "interface/tsp_interface.py",  // deliver the data to this script... it will answer back with a solution
      data: {useTheseMarkers:useTheseMarkers},
      success: function(answerText)
      {

        answeredGeoJson = JSON.parse(answerText);

        document.getElementById('distance-slider-area').innerHTML = "Length: " + ((answeredGeoJson.properties.objective)/1000).toFixed(2) + " km";

        var myRouteCoordinates = new Array();
        var myRearrangedCoords = new Array();
        myFriendlyGeoJsonObject = answeredGeoJson;

        someSortOfCounter = 0;
        $.each(myFriendlyGeoJsonObject.features, function(i, v) {
          myRouteOrigin = v.geometry.coordinates;
          dest = v.properties.assignedTo;
          myRouteDest = myFriendlyGeoJsonObject.features[dest].geometry.coordinates;
          myRearrangedCoords[0] = [myRouteOrigin[1],myRouteOrigin[0]];
          myRearrangedCoords[1] = [myRouteDest[1],myRouteDest[0]];
          polyline1[someSortOfCounter] = L.polyline(myRearrangedCoords, {color: '#ccffff', weight:16, opacity:0.12});
          polyline2[someSortOfCounter] = L.polyline(myRearrangedCoords, {color: '#006699', weight:6, opacity:1});
          polyline3[someSortOfCounter] = L.polyline(myRearrangedCoords, {color: '#66ccff', weight:4, opacity:1});
          someSortOfCounter++;
        });

        for (index = 0; index < polyline1.length; ++index) {
            polyline1[index].addTo(map);
        }

        for (index = 0; index < polyline2.length; ++index) {
            polyline2[index].addTo(map);
        }

        for (index = 0; index < polyline3.length; ++index) {
            polyline3[index].addTo(map);
        }

        // if you ever want to use a marker icon instead, here you go...
        ffffffIcon = L.icon({
            iconUrl: '/images/ffffff.png',
            iconSize:     [6, 6], // size of the icon
            iconAnchor:   [3, 3], // point of the icon which will correspond to marker's location
        });

        pointMarkers = L.geoJson(answeredGeoJson, {
          pointToLayer: function (feature, latlng) {

            return L.circleMarker(latlng, {radius: 5, fillColor: "#ffffff", color:"#006699",weight:2,opacity:1,fillOpacity:0.65});
            // return L.marker(latlng, {icon: ffffffIcon}).bindPopup(String(latlng));
          }
        });

        pointMarkers.addTo(map);


      },
      error: function()
      {
        //// fail --- todo: add a nice fallback
      }
    });

  });

  // add basemap tiles from Mapzen's Tangram
  var map = L.map('map', {zoomControl: false});
  var backgroundLayer = Tangram.leafletLayer({
    scene: 'grayprint.yaml',
    attribution: '<a href="arogi.com">Arogi</a> | &copy; <a href="http://osm.org">OpenSteetMap</a> | <a href="https://mapzen.com/tangram" target="_blank">Mapzen</a>'
  });
  backgroundLayer.addTo(map);

  L.control.scale().setPosition('bottomright').addTo(map);
  new L.Control.Zoom({ position: 'bottomright' }).addTo(map);

  // not shown, but read just to get appropriate map bounds... before the ajax call
  pointMarkers2 = L.geoJson(answeredGeoJson, {
    pointToLayer: function (feature, latlng) {
      return L.circleMarker(latlng);
    }
  });

  // pointMarkers2.addTo(map);
  map.fitBounds(pointMarkers2, {padding:[140,140]});

  </script>

</body>

</html>
